{% extends "base.html" %}
{% block title %}Generate Quiz â€” QuizGen{% endblock %}

{% block content %}
<div class="page-header">
  <div>
    <h1 class="page-title">Configure Your Quiz</h1>
    <p class="page-sub">Set your preferences and let AI do the rest</p>
  </div>
</div>

{% if error %}
<div class="alert alert-error">{{ error }}</div>
{% endif %}

<div class="generate-layout">
  <form method="POST" action="/quiz/generate" id="generateForm">

    <!-- Source Selection -->
    <div class="card">
      <h2 class="card-title">1. Choose Your Source</h2>
      <div class="source-tabs">
        <button type="button" class="tab-btn active" data-tab="existing">Existing Source</button>
        <button type="button" class="tab-btn" data-tab="topic">Enter Topic</button>
      </div>

      <div class="tab-content" id="tab-existing">
        <div class="form-group">
          <label for="source_id">Select a source</label>
          <select name="source_id" id="source_id">
            <option value="">â€” Select a source â€”</option>
            {% for s in sources %}
            <option value="{{ s.id }}" {% if selected_source and selected_source.id == s.id %}selected{% endif %}>
              {% if s.source_type == 'topic' %}ðŸ’¡ {{ s.topic }}{% else %}ðŸ“„ {{ s.file_name }}{% endif %}
            </option>
            {% endfor %}
          </select>
        </div>
        <p class="form-hint">Don't see your file? <a href="/sources/">Upload it here</a></p>
      </div>

      <div class="tab-content hidden" id="tab-topic">
        <div class="form-group">
          <label for="topic">Topic</label>
          <input type="text" id="topic" name="topic" placeholder="e.g. Machine Learning, French Revolution..." />
        </div>
      </div>
    </div>

    <!-- Quiz Settings -->
    <div class="card">
      <h2 class="card-title">2. Quiz Settings</h2>

      <div class="settings-grid">
        <div class="form-group">
          <label for="num_questions">Number of Questions <span class="label-hint">(max 10)</span></label>
          <div class="range-group">
            <input type="range" id="num_questions" name="num_questions" min="1" max="10" value="5"
                   oninput="document.getElementById('numDisplay').textContent = this.value" />
            <span class="range-display" id="numDisplay">5</span>
          </div>
        </div>

        <div class="form-group">
          <label for="difficulty">Difficulty</label>
          <div class="difficulty-picker">
            <label class="diff-option">
              <input type="radio" name="difficulty" value="easy" />
              <span class="diff-btn">Easy</span>
            </label>
            <label class="diff-option">
              <input type="radio" name="difficulty" value="medium" checked />
              <span class="diff-btn active">Medium</span>
            </label>
            <label class="diff-option">
              <input type="radio" name="difficulty" value="hard" />
              <span class="diff-btn">Hard</span>
            </label>
          </div>
        </div>

        <div class="form-group">
          <label>Time Limit</label>
          <div class="time-grid">
            <button type="button" class="time-btn active" data-seconds="120">2 min</button>
            <button type="button" class="time-btn" data-seconds="300">5 min</button>
            <button type="button" class="time-btn" data-seconds="600">10 min</button>
            <button type="button" class="time-btn" data-seconds="900">15 min</button>
            <button type="button" class="time-btn" data-seconds="1800">30 min</button>
            <button type="button" class="time-btn" data-seconds="custom">Custom</button>
          </div>
          <div class="custom-time hidden" id="customTimeGroup">
            <input type="number" id="customMinutes" placeholder="Minutes" min="1" max="60" />
          </div>
          <input type="hidden" name="time_limit_seconds" id="timeLimitInput" value="120" />
        </div>
      </div>
    </div>

    <div class="generate-actions">
      <a href="/dashboard" class="btn btn-ghost">Cancel</a>
      <button type="submit" class="btn btn-primary btn-lg" id="genBtn">
        <span id="genBtnText">âš¡ Generate Quiz</span>
        <span id="genBtnLoading" class="hidden">Generating...</span>
      </button>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Tabs
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
      document.getElementById('tab-' + btn.dataset.tab).classList.remove('hidden');

      // Clear the other field
      if (btn.dataset.tab === 'topic') {
        document.getElementById('source_id').value = '';
      } else {
        document.getElementById('topic').value = '';
      }
    });
  });

  // Difficulty picker
  document.querySelectorAll('input[name="difficulty"]').forEach(radio => {
    radio.addEventListener('change', () => {
      document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
      radio.nextElementSibling.classList.add('active');
    });
  });

  // Time buttons
  const timeLimitInput = document.getElementById('timeLimitInput');
  document.querySelectorAll('.time-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      if (btn.dataset.seconds === 'custom') {
        document.getElementById('customTimeGroup').classList.remove('hidden');
      } else {
        document.getElementById('customTimeGroup').classList.add('hidden');
        timeLimitInput.value = btn.dataset.seconds;
      }
    });
  });

  document.getElementById('customMinutes').addEventListener('input', function () {
    timeLimitInput.value = parseInt(this.value || 5) * 60;
  });

  // Loading state on submit
  document.getElementById('generateForm').addEventListener('submit', () => {
    document.getElementById('genBtnText').classList.add('hidden');
    document.getElementById('genBtnLoading').classList.remove('hidden');
    document.getElementById('genBtn').disabled = true;
  });
</script>
{% endblock %}
